version: "3.8"

x-app-defaults: &app-defaults
  image: ${APP_IMAGE:?APP_IMAGE is required}
  env_file:
    - ${ENV_FILE:?ENV_FILE is required}
  depends_on:
    - rabbitmq
  networks:
    - celery_network
  restart: unless-stopped

services:
  rabbitmq:
    image: rabbitmq:3-management
    restart: unless-stopped
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    networks:
      - celery_network

  web:
    <<: *app-defaults
    command: ${WEB_COMMAND:-gunicorn celery_demo.wsgi:application --bind 0.0.0.0:8000}
    ports:
      - "${WEB_PORT:-8000}:8000"

  celery:
    <<: *app-defaults
    environment:
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-amqp://guest:guest@rabbitmq:5672/}
    command: ${CELERY_COMMAND:-celery -A celery_demo worker --loglevel=info}

networks:
  celery_network:
    driver: bridge

